#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

mkdir -p $2

echo "-----> Cloning google/woff2"
cd $1
git clone --recursive https://github.com/google/woff2.git
cd woff2
git reset --hard 53846e1861e713c4fdcfea98492aef24f265e9e5
echo "-----> Compiling woff2"
make clean all

echo "-----> Cloning sfnt2woff"
cd $1
git clone https://github.com/samboy/WOFF.git sfnt2woff
cd sfnt2woff
echo "-----> Compiling sfnt2woff"
make


echo "-----> Cloning ttfautohint-build"
TTF_CACHE_DIR=$2/ttfautohint-build
TTF_BIN_DIR=$HOME/
if [ -d "$TTF_CACHE_DIR" ]; then
    echo "-----> Restoring cache"
    cp -r $TTF_CACHE_DIR $HOME/ttfautohint-build/local/bin
else
    echo "-----> Building from source"
    TMP_DIR=/tmp/ttfautohint-build
    cd $1
    git clone https://github.com/source-foundry/ttfautohint-build $TMP_DIR
    cd $TMP_DIR
    make
    mkdir -p $TTF_CACHE_DIR
    cp -r $HOME/ttfautohint-build/local/bin $TTF_CACHE_DIR
fi



echo "-----> Adding .profile.d script"
mkdir -p $1/.profile.d
echo 'PATH=$PATH:$HOME/woff2:$HOME/sfnt2woff:$TTF_BIN_DIR' > $1/.profile.d/woff-tools.sh
