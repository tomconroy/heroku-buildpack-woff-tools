#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -x
set -v

mkdir -p $2

WOFF2_CACHE_DIR=$2/woff2
mkdir -p $WOFF2_CACHE_DIR
WOFF2_BIN_DIR=$HOME/woff2
mkdir -p $WOFF2_BIN_DIR
if [ -d "$WOFF2_CACHE_DIR" ]; then
    echo "-----> Restoring woff2 from cache"
    echo "$(ls $WOFF2_CACHE_DIR)"
    cp -r $WOFF2_CACHE_DIR $WOFF2_BIN_DIR
    echo "$(ls $HOME)"
else
    echo "-----> Cloning google/woff2"
    WOFF2_BUILD_DIR=/tmp/woff2
    cd $1
    git clone --recursive https://github.com/google/woff2.git $WOFF2_BUILD_DIR
    cd $WOFF2_BUILD_DIR
    git reset --hard 53846e1861e713c4fdcfea98492aef24f265e9e5
    echo "-----> Compiling woff2"
    make clean all
    cp woff2_* $WOFF2_CACHE_DIR
    cp -r $WOFF2_CACHE_DIR $WOFF2_BIN_DIR
fi



echo "-----> Cloning sfnt2woff"
cd $1
git clone https://github.com/samboy/WOFF.git sfnt2woff
cd sfnt2woff
echo "-----> Compiling sfnt2woff"
make


TTF_CACHE_DIR=$2/ttfautohint-build
TTF_BIN_DIR=$HOME/
if [ -d "$TTF_CACHE_DIR" ]; then
    echo "-----> Restoring cache"
    cp -r $TTF_CACHE_DIR $HOME/ttfautohint-build/local/bin
else
    echo "-----> Cloning ttfautohint-build"
    TMP_DIR=/tmp/ttfautohint-build
    cd $1
    git clone https://github.com/source-foundry/ttfautohint-build $TMP_DIR
    cd $TMP_DIR
    echo "-----> Building ttfautohint"
    make
    mkdir -p $TTF_CACHE_DIR
    cp -r $HOME/ttfautohint-build/local/bin $TTF_CACHE_DIR
fi



echo "-----> Adding .profile.d script"
mkdir -p $1/.profile.d
echo 'PATH=$PATH:$HOME/woff2:$HOME/sfnt2woff:$TTF_BIN_DIR' > $1/.profile.d/woff-tools.sh
